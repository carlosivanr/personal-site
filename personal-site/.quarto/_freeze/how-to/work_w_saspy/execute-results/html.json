{
  "hash": "8dcafaae4cbf1c4ab2795f03731128e9",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Work with SASPy\"\nhtml:\n    toc: true\n\nexecute:\n  eval: true\n\njupyter: py_env\n---\n\n\n\n\n\n\n# Initiate a session\nOnce SASPy is configured the first step in working with SASPy is to initiate a session. This will launch a SAS session in the background that will be available to run statistical analyses on any input data. \n\n::: {#ab02a7ff .cell execution_count=1}\n``` {.python .cell-code}\n# Data manipulation\nimport pandas as pd\n\n# Module with sample data set\nimport bambi as bmb\n\n# Interface with SAS\nimport saspy\n\n# Loads a custom function\nfrom my_fx.utilities import format_pval_df\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWARNING (pytensor.configdefaults): g++ not available, if using conda: `conda install gxx`\nWARNING (pytensor.configdefaults): g++ not detected!  PyTensor will be unable to compile C-implementations and will default to Python. Performance may be severely degraded. To remove this warning, set PyTensor flags cxx to an empty string.\n```\n:::\n:::\n\n\n::: {#cffbeec7 .cell execution_count=2}\n``` {.python .cell-code}\nsas = saspy.SASsession(cfgname = 'autogen_winlocal')\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSAS Connection established. Subprocess id is 18932\n\n```\n:::\n:::\n\n\n# Load an example data set\n\n::: {#9e83b000 .cell execution_count=3}\n``` {.python .cell-code}\ndata = bmb.load_data(\"sleepstudy\")\n```\n:::\n\n\n::: {#ff0fe163 .cell execution_count=4}\n``` {.python .cell-code}\ndata.head()\n```\n\n::: {.cell-output .cell-output-display execution_count=4}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>Reaction</th>\n      <th>Days</th>\n      <th>Subject</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>249.5600</td>\n      <td>0</td>\n      <td>308</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>258.7047</td>\n      <td>1</td>\n      <td>308</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>250.8006</td>\n      <td>2</td>\n      <td>308</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>321.4398</td>\n      <td>3</td>\n      <td>308</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>356.8519</td>\n      <td>4</td>\n      <td>308</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\n# Send data to SAS\nThe next step in working with SASPy is to send a Pandas data frame to SAS. This command will send the data frame \"data\" to the background SAS session. Before sending data to SAS, it may be a good idea to double check that SAS has the proper formatting for dates and that the values, if categorical are recoded to comply with SAS column and value conventions. By default this data will be named _df and will be found in the work library\n\n::: {#240be9fd .cell execution_count=5}\n``` {.python .cell-code}\nsas_data = sas.df2sd(data, verbose = False)\n```\n:::\n\n\n# Submit SAS commands\nThe main functions to submit sas commands on data that is available in the sas session are `sas.submit()` and `sas.submitLST()`. The primary difference is that the LST version of the function will display the log and any output in the viewer when working in Positron. I personally use the LST version of the function to ensure that the SAS procedures are running correctly. When it is determined that the SAS procedures are running correctly. I then will remove the LST and then extract the tables from SAS to display in a Quarto document.  To save the output of SAS procedures I use ods output statements as in the example below. \n\n::: {#7c5ead0e .cell execution_count=6}\n``` {.python .cell-code}\n# Use sas.submitLST() to display output in viewer in an interactive session,\n# but use sas.submit() when rendering a .qmd document.\nc = sas.submit(\n\"\"\"\nods output Tests3=type3_results;\n\nproc mixed data = work._df;\n  class Subject Days;\n  model Reaction = Days;\n  random intercept/subject = Subject;\nrun;\n\"\"\")\n```\n:::\n\n\n# Retrieve ods output tables from SAS\nIn the code chunk above, we set ods output to save the Type 3 sums of squares results to a table named type3_results. We can then retrieve that table from SAS into our Python environment. Once in the Python environment, the tables can be formatted to your liking and purpose. Here's an example of how to format the Test3 table using a custom function to format the p-values.\n\n::: {#7901b358 .cell execution_count=7}\n``` {.python .cell-code}\ntype3_results = sas.sasdata(\"type3_results\", libref = \"work\").to_df()\n\n# Format the p values\ntype3_results[\"ProbF\"] = format_pval_df(type3_results['ProbF'])\n\n# Round all numberical values, set index and display\ntype3_results.round(2).set_index(\"Effect\")\n```\n\n::: {.cell-output .cell-output-display execution_count=7}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>NumDF</th>\n      <th>DenDF</th>\n      <th>FValue</th>\n      <th>ProbF</th>\n    </tr>\n    <tr>\n      <th>Effect</th>\n      <th></th>\n      <th></th>\n      <th></th>\n      <th></th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>Days</th>\n      <td>9.0</td>\n      <td>153.0</td>\n      <td>18.7</td>\n      <td>&lt;0.0001</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\n",
    "supporting": [
      "work_w_saspy_files"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}